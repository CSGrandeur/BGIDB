$(document).ready(function(){function F(){S&&(m=g.width/q.width,l=n=v=0)}function p(){if(N)drawMask(0);else{z=document.createElement("canvas");z.width=800;z.height=800;e=z.getContext("2d");e.clearRect(0,0,z.width,z.height);e.drawImage(q,n,l,q.width*m,q.height*m);for(var c=0;2>c;c++){var a=c,b=a,d=t[a];e.save();e.translate(n,l);0!=b&&(e.globalAlpha=.3);for(b=0;b<d.length;b++)e.beginPath(),"c"!=d[b].type&&(e.fillStyle="#000000",e.arc(d[b].x*m,d[b].y*m,1.5,0,2*Math.PI,!0)),e.closePath(),e.stroke(),e.fill();
	e.restore();d=B;null!=d&&0!=x&&(e.save(),e.translate(n,l),e.beginPath(),e.fillStyle="#FFFF00",e.rect(d.x*m-5,d.y*m-5,10,10),e.closePath(),e.stroke(),e.restore());d=u[a];if(!(2>t[a].length)){e.save();e.translate(n,l);e.beginPath();a=d;if(0!=a.length){e.moveTo(a[0].x*m,a[0].y*m);for(d=1;d<a.length;d++)e.lineTo(a[d].x*m,a[d].y*m);e.lineTo(a[0].x*m,a[0].y*m)}e.strokeStyle="#ffffff";e.lineWidth=1;e.stroke();e.closePath();e.restore()}}O.clearRect(0,0,g.width,g.height);O.drawImage(z,0,0);var d=u["0"],c=
	u["1"],P=b=-1;if(0!=d.length){for(var r=1E9,h=-1,a=0;a<d.length;a++)r=Math.min(r,d[a].y),h=Math.max(h,d[a].y);$("#cupheight").attr("value",(h-r).toFixed(2));b=h-r}if(0!=c.length){r=1E9;h=-1;for(a=0;a<c.length;a++)r=Math.min(r,c[a].y),h=Math.max(h,c[a].y);$("#discheight").attr("value",(h-r).toFixed(2));P=h-r}0<P&&0<b&&$("#cdr").attr("value",(b/P).toFixed(5));if(0!=c.length){for(a=b=d=0;a<c.length;a++)b+=c[a].x,d+=c[a].y;b/=c.length;d/=c.length;$("#roi").attr("value",b.toFixed(1)+","+d.toFixed(1))}}}
	function y(c,a,b){c=c.getBoundingClientRect();return{x:a-c.left,y:b-c.top}}function w(){for(var c=0;1>=c;c++){var a=t[c],b=C[c],d=points_ellipse_ass_array[c];switch(5){case 0:for(var g=0;g<a.length;g++)u[parseInt(c)][g]=a[g];break;case 5:var g=u,m=parseInt(c),d=a,a=[];if(3<=d.length){for(var h=d.length,k=[],f=0;f<h;f++)for(k[f]=[],b=0;b<h+2;b++)k[f][b]=0;for(f=0;f<h;f++)k[f][(f-1+h)%h]=1,k[f][f]=4,k[f][(f+1)%h]=1;for(f=0;f<h;f++)k[f][h]=6*d[f].x,k[f][h+1]=6*d[f].y;for(f=0;f<h;f++){d=f;for(b=f+1;b<
	h;b++)Math.abs(k[b][f])>Math.abs(k[d][f])&&(d=b);if(d!=f)for(b=0;b<h+2;b++){var e=k[d][b];k[d][b]=k[f][b];k[f][b]=e}for(b=h;b>=f;b--)for(d=f+1;d<h;++d)k[d][b]-=k[d][f]/k[f][f]*k[f][b],b==h&&(k[d][b+1]-=k[d][f]/k[f][f]*k[f][b+1])}for(f=h-1;0<=f;f--){for(b=f+1;b<h;b++)k[f][h]-=k[b][h]*k[f][b],k[f][h+1]-=k[b][h+1]*k[f][b];k[f][h]/=k[f][f];k[f][h+1]/=k[f][f]}for(f=0;f<h;f++)for(d=.1;1>d;d+=.1){e=[];for(b=h;b<h+2;b++){var l=k[(f-1+h)%h][b],n=k[f][b],p=k[(f+1)%h][b];e[b-h]=(1/6*(k[(f+2)%h][b]-l)+.5*(n-
		p))*d*d*d+(.5*(p+l)-n)*d*d+.5*(p-l)*d+(1/6*(p+l)+2/3*n)}a.push({x:e[0],y:e[1]})}}g[m]=a;break;case 6:g=u;m=parseInt(c);a=[];if(2==b.length)for(h=(b[0].x+b[1].x)/2,k=(b[0].y+b[1].y)/2,f=Math.abs(b[0].x-b[1].x)/2,b=Math.abs(b[0].y-b[1].y)/2,d=f>b?1/f:1/b,a.push({x:h+f,y:k}),e=0;e<2*Math.PI;e+=d)a.push({x:h+f*Math.cos(e),y:k+b*Math.sin(e)});g[m]=a;break;case 7:g=u;m=parseInt(c);a=c;h=[];if(0==a&&2==D)a=points_ellipse_ass_array[a];else if(1==a&&2==G)a=points_ellipse_ass_array[a];else{if(2==d.length)if(k=
			(d[0].x+d[1].x)/2,f=(d[0].y+d[1].y)/2,b=Math.abs(d[0].x-d[1].x)/2,d=Math.abs(d[0].y-d[1].y)/2,e=b>d?1/b:1/d,0==a&&1==D){D=2;e=2*Math.PI/16;h.push({x:k+b,y:f});for(l=0;l<2*Math.PI;l+=e)h.push({x:k+b*Math.cos(l),y:f+d*Math.sin(l)});points_ellipse_ass_array[a]=h}else if(1==a&&1==G){G=2;e=2*Math.PI/28;h.push({x:k+b,y:f});for(l=0;l<2*Math.PI;l+=e)h.push({x:k+b*Math.cos(l),y:f+d*Math.sin(l)});points_ellipse_ass_array[a]=h}else for(h.push({x:k+b,y:f}),l=0;l<2*Math.PI;l+=e)h.push({x:k+b*Math.cos(l),y:f+d*
	Math.sin(l)});a=h}g[m]=a;break;default:alert("generateDefault")}}}function E(){t=[];H=[];C=[];I=[];points_ellipse_ass_array=[];assFLAG=0;u=[];for(var c=0;2>c;c++)t[c]=[],H[c]=[],C[c]=[],I[c]=[],points_ellipse_ass_array[c]=[],u[c]=[];D=G=0}function T(){if(6==Q){var c=C[0],a=I[0];2==c.length&&(a.push(c.pop()),a.push(c.pop()))}else c=t[0],a=H[0],0<c.length&&a.push(c.pop());w();p()}function R(c,a,b){return 10>Math.abs(c.x-a)&&10>Math.abs(c.y-b)?!0:!1}function J(){g.onmousemove=function(c){var a,b;if(1==
		x){a=y(g,c.clientX,c.clientY);c=Math.floor((a.x-n)/m);var d=Math.floor((a.y-l)/m),e=t[0];b=e.length;for(a=0;a<b;a++)if(R(e[a],c,d)){B=e[a];B.type="h";break}p()}}}function Z(c){this.url=c;this.savePNG=function(a,b){if(a&&c){b=b||"picture";var d=a.toDataURL("image/png"),d=d.substr(d.indexOf(",")+1).toString(),g=document.createElement("input");g.setAttribute("name","imgdata");g.setAttribute("value",d);g.setAttribute("type","hidden");d=document.createElement("input");d.setAttribute("name","name");d.setAttribute("value",
		b+".png");var e=document.createElement("form");e.method="post";e.action=c;e.appendChild(g);e.appendChild(d);document.body.appendChild(e);e.submit();document.body.removeChild(e)}}}$(document).bind("contextmenu",function(c){return!1});var v=0,z,e,g,O,q,S,n=0,l=0,m=1,t=[[],[]],H=[[],[]],C=[[],[]],I=[[],[]],u=[[],[]],B,A,K,L,M,U,V,W,X,D=0,G=0,N=0,Y,x,Q;g=$("#tab_canvas")[0];O=g.getContext("2d");A=$("#tab_statue");K=$("#tab_undo");L=$("#tab_redo");M=$("#tab_clear");btn_ass=$("#tab_ass");U=$("#tab_bSpline");
	V=$("#tab_prePic");W=$("#tab_nextPic");X=$("#tab_forPic");Y=$("#tab_picID");$("#tab_task");x=!1;(function(){q=new Image;q.onload=function(){S=!0;m=g.width/q.width;p()};q.src="img.jpg";$("#tab_picID").attr("value",$("#imginfo").attr("imgid"))})();E();F();V.click(function(){E();getPrePic();F()});W.click(function(){E();getNextPic();F()});X.click(function(){E();getForPic(Y[0].value);F()});M.click(function(){E();p()});U.click(function(){Q=5;w();p()});A.click(function(){"btn btn-success"==A.attr("class")?
		((new Date).getTime(),A.attr("class","btn btn-danger"),A[0].innerHTML="Stop",$("#tab_statue_dropdown").attr("class","btn btn-danger dropdown-toggle"),K[0].disabled=!1,L[0].disabled=!1,M[0].disabled=!1,x=!0):((new Date).getTime(),A[0].className="btn btn-success",A[0].innerHTML="Start",$("#tab_statue_dropdown").attr("class","btn btn-success dropdown-toggle"),K[0].disabled=!0,L[0].disabled=!0,M[0].disabled=!0,x=!1);p()});K.click(function(){T()});btn_ass.click(function(){(new Date).getTime();D=1;w();
		p()});L.click(function(){if(6==Q){var c=C[0],a=I[0];if(2<=a.length){for(;0<c.length;)c.pop();c.push(a.pop());c.push(a.pop())}}else c=t[0],a=H[0],0<a.length&&c.push(a.pop());w();p()});g.onmousemove=function(c){var a,b;if(1==x){a=y(g,c.clientX,c.clientY);c=Math.floor((a.x-n)/m);var d=Math.floor((a.y-l)/m),e=t[0];b=e.length;for(a=0;a<b;a++)if(R(e[a],c,d)){B=e[a];B.type="h";break}w();p()}};g.onmouseout=function(c){J()};g.onmousedown=function(c){var a,b=t[0],d=b.length;if(0==x){if(1==c.button){var e=y(g,
		c.clientX,c.clientY);c.preventDefault();g.onmousemove=function(a){g.style.cursor="move";a=y(g,a.clientX,a.clientY);var b=a.x-e.x,c=a.y-e.y;e=a;n+=b;l+=c;p()};g.onmouseup=function(){g.onmousemove=null;g.onmouseup=null;g.style.cursor="default";J()}}}else{var e=y(g,c.clientX,c.clientY),r=Math.floor((e.x-n)/m),h=Math.floor((e.y-l)/m);for(a=0;a<d;a++)if(R(b[a],r,h)){g.onmousemove=function(c){g.style.cursor="move";c=y(g,c.clientX,c.clientY);var d=Math.floor((c.y-l)/m);b[a].x=Math.floor((c.x-n)/m);b[a].y=
		d;w();p()};g.onmouseup=function(a){g.onmousemove=null;g.onmouseup=null;g.style.cursor="default";J()};return}g.onmouseup=function(){var a=y(g,c.clientX,c.clientY),d=Math.floor((a.x-n)/m),a=Math.floor((a.y-l)/m),e=b.length;if(0==e||10<Math.abs(b[e-1].x-d)||10<Math.abs(b[e-1].y-a))b.push({x:d,y:a}),w(),p();g.onmousemove=null;g.onmouseup=null;g.style.cursor="default";J()}}};g.onwheel=function(c){if(1!=x){var a=y(g,c.clientX,c.clientY);c.wheelDelta=c.wheelDelta?c.wheelDelta:-40*c.deltaY;if(0<c.wheelDelta){if(5<=
		v)return;v++;m*=2;n=2*n-a.x;l=2*l-a.y}else{if(5<=-v)return;v--;m/=2;n=n/2+a.x/2;l=l/2+a.y/2}p()}};$(document).bind("keydown","ctrl+s",function(){resCommit();return!1});$(document).bind("keydown","ctrl+z",function(){T();return!1});(function(){var c=navigator.userAgent.toLowerCase(),a="ipad"==c.match(/ipad/i),b="iphone os"==c.match(/iphone os/i),d="midp"==c.match(/midp/i),e="rv:1.2.3.4"==c.match(/rv:1.2.3.4/i),l="ucweb"==c.match(/ucweb/i),h="android"==c.match(/android/i),k="windows ce"==c.match(/windows ce/i),
		c="windows mobile"==c.match(/windows mobile/i);a||b||d||e||l||h||k||c?(a=function(){g.width=$(window).get(0).innerWidth/10*9;800<g.width&&(g.width=800);g.height=g.width/4*3;p()},$("#phone_nav").show(),$(window).resize(a),a()):$("#phone_nav").hide()})();$("#hand_right").click(function(){n+=-g.width/10;p()});$("#hand_left").click(function(){n+=g.width/10;p()});$("#hand_down").click(function(){l+=-g.height/10;p()});$("#hand_up").click(function(){l+=g.height/10;p()});$("#size_large").click(function(){5<=
	v||(v++,m*=2,n=2*n-g.width/2,l=2*l-g.height/2,p())});$("#size_small").click(function(){5<=-v||(v--,m/=2,n=n/2+g.width/2/2,l=l/2+g.height/2/2,p())});$("#tab_mask").click(function(){N=N?0:1;w();p()});$("#tab_mask_export").click(function(){var c=new Z("/bgidb/tab/saveMask"),a=document.createElement("canvas");a.width=q.width;a.height=q.height;ctxMask=a.getContext("2d");ctxMask.clearRect(0,0,a.width,a.height);ctxMask.fillStyle="#000000";ctxMask.fillRect(0,0,q.width,q.height);for(var b=0;3>b;b++)if(w(),
			points_generate=u[0],0!=points_generate.length){console.log(b);ctxMask.save();ctxMask.translate(0,0);ctxMask.fillStyle="rgba(255,255,255,.666)";ctxMask.lineWidth=10;ctxMask.beginPath();ctxMask.moveTo(points_generate[0].x,points_generate[0].y);for(var d=1;d<points_generate.length;d++)ctxMask.lineTo(points_generate[d].x,points_generate[d].y);ctxMask.closePath();ctxMask.fill();ctxMask.restore()}c.savePNG(a,"cupmask")})});